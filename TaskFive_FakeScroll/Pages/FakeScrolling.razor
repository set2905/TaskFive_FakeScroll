@page "/"
@using TaskFive_FakeScroll.Models;
@using TaskFive_FakeScroll.Services.Interfaces;
@inject HttpClient Http
@inject IFakePersonGenService FakePersonGenService

<PageTitle>Fake people</PageTitle>
<RadzenRow>
    <RadzenColumn OffsetMD="1" SizeMD="10">
        <RadzenRow>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Start" Wrap="FlexWrap.Wrap">
                <RadzenDropDown TValue="string" Value=@currentLocale Data=@locales Change="@HandleLocaleChange" Style="width: 100%; max-width: 400px;" />
                <RadzenTextBox ValueChanged="@HandleSeedChange" class="w-100" />
            </RadzenStack>
        </RadzenRow>

        <RadzenRow JustifyContent="JustifyContent.Center">

            <RadzenDataGrid @ref="grid" AllowColumnResize="true" Responsive="true" Density="Density.Default" Data="@fakePeople" Count="@count" LoadData="@LoadData" TItem="FakePerson" AllowVirtualization="true" Style="height:100%; max-height:800px">
                <Columns>
                    <RadzenDataGridColumn MinWidth="25px" Width="25px" TItem="FakePerson" Property="Num" Title="№" />
                    <RadzenDataGridColumn Width="100px" TItem="FakePerson" Property="FullName" Title="Full Name" />
                    <RadzenDataGridColumn Width="100px" TItem="FakePerson" Property="Phone" Title="Phone Number" />
                    <RadzenDataGridColumn Width="300px" TItem="FakePerson" Property="Address" Title="Address" />
                </Columns>
            </RadzenDataGrid>

        </RadzenRow>
    </RadzenColumn>
</RadzenRow>

@code {
    private RadzenDataGrid<FakePerson> grid = new();
    private IEnumerable<FakePerson>? fakePeople;
    private int count = 10;
    private string currentLocale = "en";
    private readonly List<string> locales = new()
    {
      "en",
      "ru",
      "de"
    };
    private int currentSkip;
    private int currentTop;
    private int currentSeed;

    private bool isRefreshInProgress = false;
    private async Task LoadData(LoadDataArgs args)
    {
        if (isRefreshInProgress) return;
        if (args == null) return;
        if (args.Skip == null||args.Top == null) return;
        await Generate((int)args.Skip, (int)args.Top);
        currentSkip = (int)args.Skip;
        currentTop = (int)args.Top;
        if (count >= int.MaxValue - 11) return;
        count = fakePeople.Last().Num+11;
    }

    private async Task Generate(int skip, int top, bool refresh = false)
    {
        if (refresh)
        {
            await grid.Reload();
        }
        fakePeople = FakePersonGenService.GetFakePersons(skip, top, currentLocale, currentSeed);
    }

    private async Task HandleLocaleChange(object locale)
    {
        currentLocale = $"{locale}";
        isRefreshInProgress = true;
        await Generate(currentSkip, currentTop, true);
        isRefreshInProgress = false;
    }

    private async Task HandleSeedChange(string value)
    {
        currentSeed = value.GetHashCode();
        isRefreshInProgress = true;
        await Generate(currentSkip, currentTop, true);
        isRefreshInProgress = false;
    }

}
